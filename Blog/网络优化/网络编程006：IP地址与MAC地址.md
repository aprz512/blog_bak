---
title: 网络编程007：IP地址与MAC地址
index_img: /cover/18.jpg
banner_img: /cover/top.jpg
date: 2020-6-18
categories: 网络优化
---

经过前面几篇文章的洗礼，你应该知道IP地址与MAC地址各自的作用。

我自己的理解就是：IP地址是用来连接子网的，MAC地址是用来处理子网内部的。

但是这只是比较粗浅的理解，如果有人问到：

```
有了IP地址，为何还要用MAC地址？
或者，有了MAC地址，为何还要IP地址？
```

对于这些问题，你该如何给他解释清楚呢？

#### 我们先来探讨一下，没有IP地址的情况：

一开始时，网络中的机器并不多。大家都连到同一个集线器就可以了，就可以实现互通。这时，机器 A 发消息到机器 B ，消息头里附上机器 B 的MAC，集线器收到消息后就广播给所有连到集线器的机器。

机器 C 收到消息，发现消息里的 MAC 地址和自己的不一样，就丢弃。机器B发现消息里的 MAC 地址和自己一样，就收到下并解析。

![网络编程懒人入门(九)：通俗讲解，有了IP地址，为何还要用MAC地址？_1.jpg](http://www.52im.net/data/attachment/forum/201811/11/221435zigm2fjme1iiejjm.jpg)

这样机制带来问题很明显：首先每次广播，给所在网络带来不必要的浪费。所以，就出现了交换机。它能识别消息里的目标 MAC 地址后，直接就消息丢到机器 B 所连接的端口中。另一个角度，**交换机必须记住所有的 MAC 地址和端口之间的关系**。

这样的机制在网络规规模小的时候是高效的。但是当网络规模扩大到全球的时候，不可能让一台交换机记录下全球这么多的网络设备，也不可能让全球的机器连接到一台交换机上。

一个交换机无法解决，那么多个交换机可以解决吗？可以解决部分问题，如下图：

![网络编程懒人入门(九)：通俗讲解，有了IP地址，为何还要用MAC地址？_2.jpg](http://www.52im.net/data/attachment/forum/201811/11/221516f7rlwl3l0l6wy072.jpg)

但是随着网络越来越大，交换机越来越多，那么交换机之间还是只能**采用广播的方式来通信**，显然是不可取的。

也就是说，当两个网络互接时，MAC 地址 + 交换机还能解决问题广播问题，但是两个以上的网络互连时，MAC 地址 + 交换机就没有办法解决广播问题了。

#### 我们再来探讨一下，没有MAC地址的情况：

我们知道OSI 7层模型，IP、TCP分别对应第三层和四层，因特网协议族并没有覆盖完整的7层 。

因特网并不存粹，还包括以太网。因为因特网是第三层协议，是没有根基的“空中楼阁”，需要以太网这样的2层网具体落地实施，而MAC地址又是2层概念，所以MAC地址就这样进入了因特网的体系结构。

当然了，如果因特网从开始制定之初，就定义了从物理层到传输层的协议，那么因特网就不再依赖于其它任何的网络，这个纯粹的因特网就只需要纯粹的IP地址，网线所插上的也不再是以太网卡，而是“因特网卡”，既然没有了以太网，也就不用什么MAC地址了。

说了历史原因，我们再说一个现实的问题：

因为 IP 地址是要设备上线以后，才能根据他进入了哪个子网来分配的，在设备还没有 IP 地址的时候（或者分配 IP 地址的过程中），我们还需要用 MAC 地址来区分不同的设备。

所以说，在现在的这个模型体系下，MAC地址是不能被省去的。



#### ARP攻击

ARP（Address Resolution Protocol），即地址解析协议，我们前面的文章说到过，是根据IP地址解析物理地址的一个TCP/IP协议。

我们通过图解的方式来深入了解ARP攻击是如何实现的。

![img](https://pic4.zhimg.com/80/v2-816508f970cea1daf14f0610569c53db_720w.jpg)



在这个局域网里面，PC1、PC2、PC3三台主机共同连接到交换机SW1上面，对应3个接口port1/2/3。假设PC3这台主机安装了ARP攻击软件或遭受ARP病毒，成为这个网络的攻击者（hacker），接下来，PC3是如何攻击的？先不急，先来回顾下PC1和PC2是如何通信的。

![img](https://pic1.zhimg.com/80/v2-6522b0e3e1b7e7058152e70953428c74_720w.jpg)

我们来看看PC3（Hacker）是如何发起ARP攻击的=>

![img](https://pic1.zhimg.com/80/v2-383f86e253b689d40ff20d648ce7afac_720w.jpg)

正常情况下，若收到的ARP请求不是给自己的，则直接丢弃；而这里PC3（Hacker）在监听之后，发起了ARP回应包：**我就是PC2（IP2-MAC3）**。

从拓扑可以出现，PC3明明是IP3对应MAC3，很显然这就是一个ARP欺骗行为。于此同时，PC2正常的ARP回应包也交到了PC1手中，我们来看PC1接下来如何处理的：

![img](https://pic2.zhimg.com/80/v2-d234cb3ec99e072f16c7000358284641_720w.jpg)



PC1收到两个ARP回应包，内容分别如下：

③我是PC2，我的IP地址是**IP2**，我的MAC地址是**MAC2**；

③我是PC2，我的IP地址是**IP2**，我的MAC地址是**MAC3**；

PC1一脸懵：**咋回事？还有这操作？不管了，我选最新的！（后到优先）**



那么问题来了，上面两个ARP回应包到底哪个先到哪个后到呢？

作为初学者，可能还在纠结前后这种naive的问题；而作为hacker，只要持续不停发出ARP欺骗包，就一定能够覆盖掉正常的ARP回应包。**稳健的ARP嗅探/渗透工具，能在短时间内高并发做网络扫描（例如1秒钟成千上百的数据包），能够持续对外发送欺骗包。**



无论如何，当PC1和PC2这种"小白"用户遇到PC3（hacker）时，最终的结果一定是这样的：

![img](https://pic2.zhimg.com/80/v2-f898793fd3a4f37272dfc31d2ecbaa55_720w.jpg)

其实就是，不断和发送 ARP 回复包，包里面的是自己的 MAC 地址，这样，后续的通信内容就会发送到自己的PC上。

就是利用 IP -> MAC 的漏洞。

这个漏洞被IPV6堵上了。

### 参考文档

https://www.zhihu.com/question/21546408

http://www.52im.net/thread-2067-1-1.html

https://zhuanlan.zhihu.com/p/28818627
