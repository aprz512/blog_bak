---
title: 网络编程003：TCP与UDP
date: 2020-6-16
categories: 网络优化
---



### 建立链接的差异

#### TCP

TCP是面向链接的，也就是我们通常说的三次握手。

![网络编程懒人入门(四)：快速理解TCP和UDP的差异_1915184-43e91a9185faa031.jpg](http://www.52im.net/data/attachment/forum/201710/27/110528h9iiyaqrryaijdgi.jpg)

这里有张图描述的有点蛋疼，大致看没问题，仔细看为题很多。我刚开始看到这张图的时候，对图里面的 ACK 值感到疑惑。

因为我发现了有两个 ack，一个大写，一个小写，他们的意义是不同的：

具体的解释可以看这里：https://blog.csdn.net/baiyan3212/article/details/81302448

上图中的 ACK 应该表示的是“确认编号”。

> 一个是确认值(Acknowledgement)，为1便是确认连接。
> 另一个是确认编号(Acknowledgement Number)。

还有一个问题，有的发送过程只写了 ACK，没有写 seq，难道是侧重点不同？？？我哪里没get到吗？？？

好的，我们仔细分析这个图，可以看出其实三次握手的主要目的是：

- 通知对方，自己发送包的初始编号。

**所以三次握手的次序是这样子的：**

1. client端首先发送一个SYN包告诉Server端我的初始序列号是X；
2. Server端收到SYN包后回复给client一个ACK确认包，告诉client说我收到了；
3. 接着Server端也需要告诉client端自己的初始序列号，于是Server也发送一个SYN包告诉client我的初始序列号是Y；
4. Client收到后，回复Server一个ACK确认包说我知道了。

其中的 2 、3 步骤可以简化为一步，也就是说将 ACK 确认包和 SYN 序列化包一同发送给 Client 端。

#### UDP

UDP 压根不会建立什么连接。UDP 只需要知道对方的 ip 地址，将数据报一份一份的发送过去就可以了，其他的作为发送方，都不需要关心。



### 数据发送方式的差异

差异主要体验在对数据包大小的限制上：

- **TCP：**
  由于 TCP 是建立在两端连接之上的协议，所以理论上发送的数据流不存在大小的限制。但是由于缓冲区有大小限制，所以你如果用 TCP 发送一段很大的数据，可能会截断成好几段，接收方依次的接收。
- **UDP：**
  由于 UDP 本身发送的就是一份一份的数据报，所以自然而然的就有一个上限的大小。

我们知道，当一个数据包超过了以太网数据帧的大小时，IP层会将数据进行分片，这对于TCP来说，没什么问题，应为它有重传与确认机制。但是UDP没有这个机制，假设一个数据包分为了 10 片，那么就需要传输10次，而只要其中某一个片丢失了，那么UDP会弃掉整个数据包，影响范围就变大了。所以最好我们使用UDP的时候，一个数据包不要超过这里的限制。

有关UDP协议的最大包长限制，详见《[UDP中一个包的大小最大能多大？](http://www.52im.net/thread-29-1-1.html)》



### 有序性的差异

TCP有序，UDP无序。



### 可靠性的差异

TCP可靠，UDP不可靠。

**研究下，什么情况会导致 UDP 丢包：**

- **数据报分片重组丢失：**在文章之前我们就说过，UDP 的每个数据报大小多少最合适，事实上 UDP 协议本身规定的大小是 64kb，但是在数据链路层有 MTU 的限制，大小大概在 5kb（这些数据dou），所以当你发送一个很大的 UDP 包的时候，这个包会在 IP 层进行分片，然后重组。这个过程就有可能导致分片的包丢失。UDP 本身有 CRC 检测机制，会抛弃掉丢失的 UDP 包；
- **UDP 缓冲区填满：**当 UDP 的缓冲区已经被填满的时候，接收方还没有处理这部分的 UDP 数据报，这个时候再过来的数据报就没有地方可以存了，自然就都被丢弃了。

### 使用场景

先来说 UDP 的吧，有很多人都会觉得 UDP 与 TCP 相比，在性能速度上是占优势的。因为 UDP 并不用保持一个持续的连接，也不需要对收发包进行确认。但事实上经过这么多年的发展 TCP 已经拥有足够多的算法和优化，在网络状态不错的情况下，TCP 的整体性能是优于 UDP 的。

**那在什么时候我们非用 UDP 不可呢？**

- **对实时性要求高：**比如实时会议，实时视频这种情况下，如果使用 TCP，当网络不好发生重传时，画面肯定会有延时，甚至越堆越多。如果使用 UDP 的话，即使偶尔丢了几个包，但是也不会影响什么，这种情况下使用 UDP 比较好；

  > 对实时要求较为严格的情况下，采用自定义的可靠UDP协议，比如Enet、RakNet（用户有 sony online game、minecraft）等，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。

- **流媒体：**采用TCP，一旦发生丢包，TCP会将后续包缓存起来，等前面的包重传并接收到后再继续发送，延迟会越来越大。

- **多点通信：**TCP 需要保持一个长连接，那么在涉及多点通讯的时候，肯定需要和多个通信节点建立其双向连接，然后有时在NAT环境下，两个通信节点建立其直接的 TCP 连接不是一个容易的事情，而 UDP 可以无需保持连接，直接发就可以了，所以成本会很低，而且穿透性好。这种情况下使用 UDP 也是没错的。


以上我们说了 UDP 的使用场景，在此之外的其他情况，使用 TCP 准没错。

**毕竟有一句话嘛：**

> when in doubt，use TCP。



### 参考文档

http://www.52im.net/thread-29-1-1.html

http://www.52im.net/thread-1160-1-1.html

http://www.52im.net/thread-1277-1-1.html

