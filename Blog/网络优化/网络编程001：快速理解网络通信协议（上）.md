---
title: 网络编程001:快速理解网络通信协议
date: 2020-6-14
categories: 网络优化
---





### 互联网的五层模型

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_1.jpg](http://www.52im.net/data/attachment/forum/201811/01/150735oly7l6bu5cffff7h.jpg)



### 层与协议

**每一层都是为了完成一种功能。为了实现这些功能，就需要大家都遵守共同的规则。大家都遵守的规则，就叫做"协议"（protocol）。**

### 链接层

通过网线传输的数据都是 0 和 1，但是单纯的 0 与 1 并没有意义，没法被解读，传输再多又有个鬼用。

"链接层"的功能：确定了0和1的分组方式。

#### 以太网协议

以太网规定，一组电信号构成一个数据包，叫做"帧"（Frame）。

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_3.jpg](http://www.52im.net/data/attachment/forum/201811/01/150929cw8a20dzzlonkene.jpg)

"标头"包含数据包的一些说明项，比如**发送者、接受者、数据类型**等等；"标头"的长度，固定为18字节。

"数据"则是数据包的具体内容。"数据"的长度，最短为46字节，最长为1500字节。

#### MAC 地址

以太网数据包的"标头"中的发送者和接受者需要使用 MAC 地址来标识。

每块网卡出厂的时候，**都有一个全世界独一无二的MAC地址**，长度是48个二进制位，通常用12个十六进制数表示。

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_5.jpg](http://www.52im.net/data/attachment/forum/201811/01/150918zzkluk96tufsl3bs.jpg)

前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了。

#### 广播

以太网使用“广播”的方式向**本网络内**的所有计算机发送数据包，让计算机自己判断是不是接收方！！！

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_6.jpg](http://www.52im.net/data/attachment/forum/201811/01/150935p07k2g2y6y7k74e0.jpg)



这里还有一个问题：通常我们发送只需要一个 ip 地址和端口就行了，那么我们是没法知道接受方的 MAC 地址的啊，那么帧数据该怎么构建呢？

**这里又可以分成两种情况：**

- **1）第一种情况：**如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理；所以对方的MAC地址这一栏，填的是网关的 MAC 地址（网关是在同一个子网，使用ARP得到MAC地址）。
- **2）第二种情况：**如果两台主机在同一个子网络，那么我们可以用**ARP**协议，得到对方的MAC地址。ARP协议也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个"广播"地址。它所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包。



### 网络层

使用广播传递数据包会有问题：

>  广播只能在子网生效，如果不这样设计，将会引发广播风暴！一台上海的电脑能与一台纽约的电脑在同一个子网吗，显然是不可能的！

这就导致了"网络层"的诞生。它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。

#### IP协议

**IPv4这个版本规定，网络地址由32个二进制位组成：**

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_8.jpg](http://www.52im.net/data/attachment/forum/201811/01/150947elp4lvaiiesuvlyu.jpg)



地址分为两部分，前面一部分为网络，后面一部分为主机。但是我们没法知道前面几位是网络，有肯能是24位，有可能是28位。所以我们需要子网掩码来判断。

> 所谓"子网掩码"，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.254.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。

最终，我们只需要将子网掩码与IP地址做位与运算，结果相等就是在子网内。

#### IP数据包

**IP数据包也分为"标头"和"数据"两个部分：**

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_9.jpg](http://www.52im.net/data/attachment/forum/201811/01/150954xykms5d9vscynnsz.jpg)



"标头"部分主要包括版本、长度、IP地址等信息，"数据"部分则是IP数据包的具体内容。它放进以太网数据包后，以太网数据包就变成了下面这样：

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_10.jpg](http://www.52im.net/data/attachment/forum/201811/01/151007ibebhdrudjqof1qp.jpg)

### 传输层

我们的电脑中有多个程序，那么传输过来的数据应该给哪个程序使用呢？需要**端口**来标识。

#### UDP协议

**UDP数据包，也是由"标头"和"数据"两部分组成：**

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_11.jpg](http://www.52im.net/data/attachment/forum/201811/01/151048jboz0nm3kommnbim.jpg)

"标头"部分主要定义了发出端口和接收端口，"数据"部分就是具体的内容。然后，把整个UDP数据包放入IP数据包的"数据"部分：

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_12.jpg](http://www.52im.net/data/attachment/forum/201811/01/151011eysfi272f6nveevs.jpg)

#### TCP协议

UDP协议的优点是比较简单，容易实现，但是缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。为了解决这个问题，提高网络可靠性，TCP协议就诞生了。

### 应用层

"应用层"的作用，就是规定应用程序的数据格式。

![网络编程懒人入门(一)：快速理解网络通信协议（上篇）_13.jpg](http://www.52im.net/data/attachment/forum/201811/01/151016iaeia7apeacny25l.jpg)

#### DHCP协议

计算机开机后，会自动分配到一个IP地址。每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做"DHCP服务器"。新的计算机加入网络，必须向"DHCP服务器"发送一个"DHCP请求"数据包，申请IP地址和相关的网络参数。

![网络编程懒人入门(二)：快速理解网络通信协议（下篇）_5.jpg](http://www.52im.net/data/attachment/forum/201811/01/153032wppxuuvdmupaqiy6.jpg)

- **1）最前面的"以太网标头"：**设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。
- **2）后面的"IP标头"：**设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。
- **3）最后的"UDP标头"：**设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。


这个数据包构造完成后，就可以发出了。以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方IP地址是0.0.0.0，接收方是255.255.255.255，于是DHCP服务器知道"这个包是发给我的"，而其他计算机就可以丢弃这个包。

接下来，DHCP服务器读出这个包的数据内容，分配好IP地址，发送回去一个"DHCP响应"数据包。这个响应包的结构也是类似的，以太网标头的MAC地址是双方的网卡地址，IP标头的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP标头的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。

新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数。

### 参考文档

http://www.52im.net/thread-1095-1-1.html

http://www.52im.net/thread-1103-1-1.html