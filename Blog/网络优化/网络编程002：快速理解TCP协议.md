---
6title: 网络编程002：快速理解TCP协议
date: 2020-6-15
categories: 网络优化
---

![网络编程懒人入门(三)：快速理解TCP协议一篇就够_72539919.jpg](http://www.52im.net/data/attachment/forum/201710/12/154924b4p49zqhrrr3rlj5.jpg)

以太网协议（Ethernet）规定了电子信号如何组成数据包（packet），解决了子网内部的点对点通信。

IP 协议实现了路由功能，允许某个局域网的 A 主机，向另一个局域网的 B 主机发送消息。

TCP 协议的作用是，保证数据通信的完整性和可靠性，防止丢包。如果路由器丢包（比如缓存满了，新进来的数据包就会丢失），就需要发现丢了哪一个包，以及如何重新发送这个包。



### TCP数据包的大小

![网络编程懒人入门(三)：快速理解TCP协议一篇就够_7.jpg](http://www.52im.net/data/attachment/forum/201710/12/152505inpkwuqxkqn5dpsn.jpg)

以太网数据包（packet）的大小是固定的，最初是1518字节，后来增加到1522字节。

这些字节里面包含了很多头，所以真正的数据大约为 1400 字节。所以我们的 HTTP 请求可能会分为多个数据包来发送。HTTP/2 协议的一大改进， 就是压缩 HTTP 协议的头信息，使得一个 HTTP 请求可以放在一个 TCP 数据包里面，而不是分成多个，这样就提高了速度。



### TCP数据包的编号

我们常听说TCP的三次握手，但是这三次握手是干嘛呢？

我们发送一个1M的文件，必然要分成很多个数据包发送，其中如果有丢包，那么怎么知道是丢了哪个包呢？

其实是在发送的时候，TCP 协议为每个包编号了。

第一个包的编号是一个随机数。为了便于理解，这里就把它称为1号包。假定这个包的负载长度是100字节，那么可以推算出下一个包的编号应该是101。

而由于TCP是两端都可以发送数据的，所以三次握手的情况大致如下：

| 序号 | 方向 | seq             | ack           |
| ---- | ---- | --------------- | ------------- |
| 1    | A->B | 10000（随机数） | 0             |
| 2    | B->A | 20000（随机数） | 10000+1=10001 |
| 3    | A->B | 10001           | 20000+1=20001 |

**确认序号（ack）**应当是上次已成功收到数据字节序号加1，它的作用是告知发送端的数据接受成功，期望下一个包的字节为此序号。

**字节序号（seq）**是上次已成功收到的确认序号，它的作用就是发送接收端期望的下一个包的数据。

在三次握手的过程中，ACK是直接加一了，但是在正式通信的时候，会不一样：

| 序号 | 方向 | seq   | ack                 | 数据长度 | 数据包长度 |
| ---- | ---- | ----- | ------------------- | -------- | ---------- |
| 23   | A->B | 40000 | 70000               | 1460     | 1514       |
| 24   | B->A | 70000 | 40000+1514-54=41460 | 0        | 54         |
| 25   | A->B | 41460 | 70000+54-54=70000   | 1460     | 1514       |
| 26   | B->A | 70000 | 41460+1514-54=42920 | 0        | 54         |

可以看到这里的 ACK 是加上了数据包的数据的长度。你可以理解为，握手的时候只发送了一个字节的数据。

四次挥手的过程与握手类似，就不多说了。

另外提一下，在三次握手的过程中，还有一个叫做 SYN 的标识，它标识希望建立链接，所以只有开始两次会有这个标识。同样的在四次握手会有 FIN 标识，标识希望断开链接。



### 数据包的遗失处理

每一个数据包都带有下一个数据包的编号。如果下一个数据包没有收到，那么 ACK 的编号就不会发生变化。

> 举例来说，现在收到了4号包，但是没有收到5号包。ACK 就会记录，期待收到5号包。过了一段时间，5号包收到了，那么下一轮 ACK 会更新编号。如果5号包还是没收到，但是收到了6号包或7号包，那么 ACK 里面的编号不会变化，总是显示5号包。这会导致大量重复内容的 ACK。

如果发送方发现收到三个连续的重复 ACK，或者超时了还没有收到任何 ACK，就会确认丢包，即5号包遗失了，从而再次发送这个包。通过这种机制，TCP 保证了不会有数据包丢失。



### 参考文档

http://www.52im.net/thread-1107-1-1.html

https://blog.csdn.net/huaishu/article/details/93739446